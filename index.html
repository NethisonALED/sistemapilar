<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pilar</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 512 512%22><path fill=%22%2310b981%22 d=%22M224 448V224H160V448h64zM32 480H480c17.7 0 32-14.3 32-32s-14.3-32-32-32H32c-17.7 0-32 14.3-32 32s14.3 32 32 32zm160-352H128V448h64V128zM320 448V256H256V448h64zM416 448V160H352V448h64zM480 64H32C14.3 64 0 49.7 0 32S14.3 0 32 0H480c17.7 0 32 14.3 32 32s-14.3 32-32 32z%22/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .app-sidebar {
            background-color: #1a1a1a;
        }
        .menu-link.active {
            background-color: #10b981; /* emerald-500 */
            color: #ffffff;
        }
        .menu-link:hover {
            background-color: #333;
            color: #ffffff;
        }
        .tab-view {
            display: none;
        }
        .tab-view.active {
            display: block;
        }
        .file-input-label {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .file-input {
            display: none;
        }
        .modal {
            display: none;
        }
        .modal.flex {
            display: flex;
        }
        #auth-container, #app-container {
            display: none; /* Escondidos por padrão */
        }
    </style>
</head>
<body class="text-gray-800 bg-gray-100">

    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-sm">
            <div class="text-center mb-8">
                <i class="fas fa-building-columns text-4xl text-emerald-500"></i>
                <h1 class="text-2xl font-bold text-gray-800 mt-2">Bem-vindo ao Pilar</h1>
                <p class="text-gray-500">Faça login para continuar</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="email" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Senha</label>
                    <input type="password" id="password" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-emerald-500 focus:border-emerald-500">
                </div>
                <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                    Entrar
                </button>
            </form>
            <p id="auth-error" class="mt-4 text-center text-sm text-red-600"></p>
        </div>
    </div>

    <div id="app-container">
        <div class="flex h-screen">
            <aside id="app-sidebar" class="app-sidebar w-64 flex-shrink-0 flex flex-col p-4 text-gray-300">
                <div class="sidebar-header px-4 pb-8 border-b border-gray-700 mb-4">
                    <a href="#" class="flex items-center gap-2 text-xl font-semibold text-white">
                        <i class="fas fa-building-columns"></i>
                        <span>Pilar</span>
                    </a>
                </div>
                <nav class="sidebar-menu px-2 flex-grow">
                    <div class="menu-section mb-6">
                        <div class="menu-title text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2 px-2">Principal</div>
                        <a href="#" class="menu-link active flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium" data-tab="relatorio-rt">
                            <i class="fas fa-file-invoice-dollar fa-fw"></i><span>Relatório de RT</span>
                        </a>
                        <a href="#" class="menu-link flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium" data-tab="consulta-sysled">
                            <i class="fas fa-database fa-fw"></i><span>Consulta Sysled</span>
                        </a>
                        <a href="#" class="menu-link flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium" data-tab="arquitetos">
                            <i class="fas fa-users fa-fw"></i><span>Arquitetos</span>
                        </a>
                        <a href="#" class="menu-link flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium" data-tab="pontuacao">
                            <i class="fas fa-star fa-fw"></i><span>Pontuação</span>
                        </a>
                        <a href="#" class="menu-link flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium" data-tab="comprovantes">
                            <i class="fas fa-receipt fa-fw"></i><span>Comprovantes</span>
                        </a>
                        <a href="#" class="menu-link flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium" data-tab="arquivos-importados">
                            <i class="fas fa-folder-open fa-fw"></i><span>Arquivos Importados</span>
                        </a>
                        <a href="#" class="menu-link flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium" data-tab="resultados">
                            <i class="fas fa-chart-pie fa-fw"></i><span>Resultados</span>
                        </a>
                    </div>
                </nav>
                <div class="sidebar-footer mt-auto px-2">
                     <a href="#" id="logout-button" class="menu-link flex items-center gap-3 py-2.5 px-3 rounded-md text-sm font-medium">
                         <i class="fas fa-sign-out-alt fa-fw"></i><span>Sair</span>
                    </a>
                </div>
            </aside>

            <main class="flex-grow p-6 md:p-10 overflow-y-auto">
                
                <div id="relatorio-rt-view" class="tab-view active">
                    <div class="container mx-auto max-w-4xl">
                        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                            <header class="mb-8 text-center">
                                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Gerar Relatório de RTs por Parceiro</h1>
                                <p class="text-gray-500 mt-2">Faça o upload do seu arquivo Excel ou CSV para gerar um relatório consolidado.</p>
                            </header>
                            <div class="bg-blue-50 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-8" role="alert">
                                <p class="font-bold">Instruções</p>
                                <p class="mt-2 text-sm">
                                    1. Selecione seu arquivo (.xlsx, .xls, ou .csv).<br>
                                    2. Na tela seguinte, associe as colunas da sua planilha aos campos do sistema.<br>
                                    3. Gere o relatório para impressão.
                                </p>
                            </div>
                            <div class="text-center">
                                <label for="rt-file-input" class="file-input-label bg-indigo-600 hover:bg-indigo-700"><i class="fas fa-upload mr-2"></i>Escolher Arquivo</label>
                                <input type="file" id="rt-file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="file-input">
                                <p id="rt-file-name" class="text-sm text-gray-500 mt-2"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="consulta-sysled-view" class="tab-view">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Consulta Sysled</h1>
                    
                    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Filtros</h2>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                            <div>
                                <label for="sysled-filter-data-inicio" class="block text-sm font-medium text-gray-700">Data Início</label>
                                <input type="date" id="sysled-filter-data-inicio" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="sysled-filter-data-fim" class="block text-sm font-medium text-gray-700">Data Fim</label>
                                <input type="date" id="sysled-filter-data-fim" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="sysled-filter-parceiro" class="block text-sm font-medium text-gray-700">Parceiro</label>
                                <input type="text" id="sysled-filter-parceiro" placeholder="Nome ou ID do parceiro" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2">
                            </div>
                            <div>
                                <label for="sysled-filter-excluir-parceiro" class="block text-sm font-medium text-gray-700">Excluir Parceiro</label>
                                <input type="text" id="sysled-filter-excluir-parceiro" placeholder="IDs separados por vírgula" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 sm:text-sm p-2">
                            </div>
                            <div class="flex items-end gap-2">
                                <button id="sysled-filter-btn" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">Filtrar</button>
                                <button id="sysled-clear-filter-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Limpar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold">Resultados da Consulta</h2>
                             <div>
                                <button id="sysled-refresh-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg mr-2"><i class="fas fa-sync-alt mr-2"></i>Atualizar Dados</button>
                                <button id="copy-to-rt-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-copy mr-2"></i>Copiar para RT</button>
                            </div>
                        </div>
                        <div id="sysled-table-container">
                            <div class="text-center text-gray-500 py-8">
                                <p>Clique em "Atualizar Dados" para carregar as informações da API Sysled.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                 <div id="arquitetos-view" class="tab-view">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Cadastro de Arquitetos</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <h2 class="text-xl font-semibold mb-4">Adicionar Manualmente</h2>
                                <form id="add-arquiteto-form" class="space-y-4">
                                    <div>
                                        <label for="arquiteto-id" class="block text-sm font-medium text-gray-600">ID</label>
                                        <input type="text" id="arquiteto-id" class="w-full p-2 bg-gray-50 border rounded-lg mt-1" required>
                                    </div>
                                    <div>
                                        <label for="arquiteto-nome" class="block text-sm font-medium text-gray-600">Nome</label>
                                        <input type="text" id="arquiteto-nome" class="w-full p-2 bg-gray-50 border rounded-lg mt-1" required>
                                    </div>
                                    <div>
                                        <label for="arquiteto-email" class="block text-sm font-medium text-gray-600">Email</label>
                                        <input type="email" id="arquiteto-email" class="w-full p-2 bg-gray-50 border rounded-lg mt-1">
                                    </div>
                                    <div>
                                        <label for="arquiteto-telefone" class="block text-sm font-medium text-gray-600">Telefone</label>
                                        <input type="tel" id="arquiteto-telefone" class="w-full p-2 bg-gray-50 border rounded-lg mt-1">
                                    </div>
                                     <div>
                                        <label for="arquiteto-pix" class="block text-sm font-medium text-gray-600">Chave PIX</label>
                                        <input type="text" id="arquiteto-pix" class="w-full p-2 bg-gray-50 border rounded-lg mt-1">
                                    </div>
                                    <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg">Adicionar Arquiteto</button>
                                </form>
                            </div>
                            <div class="bg-white rounded-2xl shadow-lg p-6">
                                <h2 class="text-xl font-semibold mb-4">Importar Planilha</h2>
                                 <div class="text-center">
                                    <label for="arquiteto-file-input" class="file-input-label bg-indigo-600 hover:bg-indigo-700"><i class="fas fa-file-excel mr-2"></i>Escolher Planilha</label>
                                    <input type="file" id="arquiteto-file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="file-input">
                                    <p id="file-name-arquitetos" class="text-sm text-gray-500 mt-2"></p>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
                            <div class="flex justify-between items-center mb-4">
                                 <h2 class="text-xl font-semibold">Arquitetos Cadastrados</h2>
                                 <div class="flex gap-2">
                                     <button id="export-csv-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Exportar CSV</button>
                                     <button id="delete-all-arquitetos-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Apagar Todos</button>
                                 </div>
                            </div>
                            <div class="mb-4">
                                 <input type="text" id="arquiteto-search-input" placeholder="Pesquisar por ID ou Nome..." class="w-full p-3 bg-gray-50 border rounded-lg">
                            </div>
                            <div id="arquitetos-table-container" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>

                <div id="pontuacao-view" class="tab-view">
                     <h1 class="text-3xl font-bold text-gray-900 mb-6">Pontuação</h1>
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                         <div class="lg:col-span-2 bg-white rounded-2xl shadow-lg p-6">
                             <h2 class="text-xl font-semibold mb-4">Ranking de Arquitetos</h2>
                             <div id="ranking-table-container"></div>
                         </div>
                         <div class="bg-white rounded-2xl shadow-lg p-6">
                             <h2 class="text-xl font-semibold mb-4">Ajuste Manual de Pontos</h2>
                             <form id="add-pontos-form" class="space-y-4">
                                 <div>
                                     <label for="arquiteto-select" class="block text-sm font-medium text-gray-600 mb-1">Arquiteto</label>
                                     <select id="arquiteto-select" class="w-full p-3 bg-gray-50 border rounded-lg" required></select>
                                 </div>
                                  <div>
                                     <label for="pontos-valor" class="block text-sm font-medium text-gray-600 mb-1">Pontos (use negativo para remover)</label>
                                     <input type="number" id="pontos-valor" class="w-full p-3 bg-gray-50 border rounded-lg" required>
                                 </div>
                                 <button type="submit" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg">Adicionar</button>
                             </form>
                         </div>
                     </div>
                </div>

                <div id="comprovantes-view" class="tab-view">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Controle de Pagamentos</h1>
                    <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-8">
                        <h2 class="text-xl font-semibold mb-4">Pesquisar Pagamentos</h2>
                        <input type="text" id="pagamento-search-input" placeholder="Pesquisar por ID do Parceiro..." class="w-full p-3 bg-gray-50 border rounded-lg">
                    </div>
                    <div id="pagamentos-container" class="space-y-8"></div>
                </div>

                 <div id="arquivos-importados-view" class="tab-view">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Arquivos Importados</h1>
                    <div id="arquivos-importados-container" class="space-y-6"></div>
                </div>

                <div id="resultados-view" class="tab-view">
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Resultados Gerais</h1>
                    <div class="flex justify-end mb-6">
                         <button id="calculate-results-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg">
                            <i class="fas fa-sync-alt mr-2"></i>Calcular Resultados
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                            <h2 class="text-sm font-medium text-gray-500">Valor de RTs Pagas</h2>
                            <p id="total-rt" class="text-3xl font-bold mt-2 text-emerald-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                            <h2 class="text-sm font-medium text-gray-500">Valor dos Pedidos</h2>
                            <p id="total-pedidos-valor" class="text-3xl font-bold mt-2 text-blue-600">R$ 0,00</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                            <h2 class="text-sm font-medium text-gray-500">Quantidade de Pedidos</h2>
                            <p id="total-pedidos-quantidade" class="text-3xl font-bold mt-2 text-indigo-600">0</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col">
                            <h2 class="text-sm font-medium text-gray-500">Pedido Médio</h2>
                            <p id="pedido-medio" class="text-3xl font-bold mt-2 text-purple-600">R$ 0,00</p>
                        </div>
                    </div>
                </div>

            </main>
        </div>
        
        <div id="rt-mapping-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 w-full max-w-3xl">
                <h2 class="text-xl font-semibold mb-4">Mapear Colunas do Relatório de RTs</h2>
                <p class="text-sm text-gray-600 mb-6">Associe as colunas da sua planilha aos campos necessários do sistema.</p>
                <form id="rt-mapping-form" class="space-y-4"></form>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-rt-mapping-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="confirm-rt-mapping-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">Confirmar e Gerar Relatório</button>
                </div>
            </div>
        </div>
        
        <div id="arquiteto-mapping-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 w-full max-w-3xl">
                <h2 class="text-xl font-semibold mb-4">Mapear Colunas de Arquitetos</h2>
                <p class="text-sm text-gray-600 mb-6">Associe as colunas da sua planilha aos campos de cadastro.</p>
                <form id="arquiteto-mapping-form" class="space-y-4"></form>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" id="cancel-arquiteto-mapping-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                    <button type="button" id="confirm-arquiteto-mapping-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">Confirmar Importação</button>
                </div>
            </div>
        </div>

        <div id="edit-arquiteto-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 w-full max-w-3xl">
                <h2 class="text-xl font-semibold mb-6 border-b pb-4">Ficha do Arquiteto</h2>
                <form id="edit-arquiteto-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <input type="hidden" id="edit-arquiteto-original-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-600">ID</label>
                        <p id="edit-arquiteto-id" class="mt-1 text-lg font-semibold text-gray-800"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Nome Completo</label>
                        <input type="text" id="edit-arquiteto-nome" class="w-full p-2 bg-gray-50 border rounded-lg mt-1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">E-mail</label>
                        <input type="email" id="edit-arquiteto-email" class="w-full p-2 bg-gray-50 border rounded-lg mt-1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Telefone</label>
                        <input type="tel" id="edit-arquiteto-telefone" class="w-full p-2 bg-gray-50 border rounded-lg mt-1">
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-600">Quantidade de Vendas</label>
                        <input type="number" id="edit-arquiteto-vendas" class="w-full p-2 bg-gray-50 border rounded-lg mt-1" min="0">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-600">Chave PIX</label>
                        <input type="text" id="edit-arquiteto-pix" class="w-full p-2 bg-gray-50 border rounded-lg mt-1">
                    </div>
                    
                    <div class="md:col-span-2 mt-4 pt-4 border-t">
                         <h3 class="text-lg font-semibold mb-2">Cálculo de RT</h3>
                         <div class="grid grid-cols-3 gap-4 items-end">
                              <div>
                                 <label class="block text-sm font-medium text-gray-600">Valor Total de Vendas</label>
                                 <p id="rt-valor-vendas" class="mt-1 text-lg font-bold text-gray-800"></p>
                             </div>
                              <div>
                                 <label for="rt-percentual" class="block text-sm font-medium text-gray-600">Percentual de RT</label>
                                 <select id="rt-percentual" class="w-full p-2 bg-gray-50 border rounded-lg mt-1">
                                     <option value="0.05">5%</option>
                                     <option value="0.10">10%</option>
                                 </select>
                             </div>
                             <div>
                                 <label class="block text-sm font-medium text-gray-600">Valor do RT</label>
                                 <p id="rt-valor-calculado" class="mt-1 text-lg font-bold text-emerald-600"></p>
                             </div>
                         </div>
                    </div>

                    <div class="md:col-span-2 flex justify-end gap-4 mt-6">
                        <button type="button" id="cancel-edit-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Fechar</button>
                        <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">Salvar Alterações</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div id="add-value-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 w-full max-w-md">
                <h2 class="text-xl font-semibold mb-4" id="add-value-modal-title">Adicionar Valor de Venda</h2>
                <form id="add-value-form">
                    <input type="hidden" id="add-value-arquiteto-id">
                    <div>
                        <label class="block text-sm font-medium text-gray-600 mb-1">Valor da Nova Venda</label>
                        <input type="number" step="0.01" id="add-value-input" class="w-full p-3 bg-gray-50 border rounded-lg" required placeholder="Ex: 1500.50">
                    </div>
                    <div class="flex justify-end gap-4 mt-6">
                        <button type="button" id="cancel-add-value-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Cancelar</button>
                        <button type="submit" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="comprovante-modal" class="modal fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 w-full max-w-lg">
                <h2 class="text-xl font-semibold mb-4" id="comprovante-modal-title">Detalhes do Pagamento</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Valor do RT</label>
                        <p id="comprovante-valor-rt" class="mt-1 text-lg font-bold text-emerald-600"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-600">Comprovante</label>
                        <div id="comprovante-img-container" class="mt-2 border rounded-lg p-2 min-h-[100px] flex items-center justify-center">
                            <p class="text-gray-500">Nenhum comprovante anexado.</p>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" id="close-comprovante-modal-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Fechar</button>
                </div>
            </div>
        </div>

    </div>

<script type="module">
    // --- Configuração do Supabase ---
    const SUPABASE_URL = 'https://lnzyibxqmrgvjhvryhtt.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxuenlpYnhxbXJndmpodnJ5aHR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTgwMDIsImV4cCI6MjA3MjEzNDAwMn0.RC53FSA1cw19c_rIh_6N4m6MgoAi4fKkFBXPy32hQKA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const authContainer = document.getElementById('auth-container');
    const appContainer = document.getElementById('app-container');
    const loginForm = document.getElementById('login-form');
    const logoutButton = document.getElementById('logout-button');
    const authError = document.getElementById('auth-error');

    let app = null;

    // --- LÓGICA DE AUTENTICAÇÃO ---
    
    // Verifica a sessão do usuário quando a página carrega
    supabase.auth.onAuthStateChange((event, session) => {
        if (session) {
            authContainer.style.display = 'none';
            appContainer.style.display = 'block';
            if (!app) { 
                app = new RelacionamentoApp();
            }
        } else {
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            app = null; 
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        authError.textContent = '';
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            authError.textContent = 'Erro: ' + error.message;
        }
    });

    logoutButton.addEventListener('click', async (e) => {
        e.preventDefault();
        const { error } = await supabase.auth.signOut();
        if (error) {
            alert('Erro ao sair: ' + error.message);
        }
    });

    class RelacionamentoApp {
        constructor() {
            this.arquitetos = [];
            this.pontuacoes = {};
            this.pagamentos = {};
            this.importedFiles = {};
            this.tempRTData = [];
            this.tempArquitetoData = [];
            
            // Propriedades da nova aba
            this.sysledData = [];
            this.sysledFilteredData = [];
            this.isSysledImport = false; // Flag para checar a origem da importação para RT
            
            this.init();
        }

        async init() {
            await this.loadData();
            this.initEventListeners();
            this.renderAll();
        }
        
        async loadData() {
            const { data: arquitetosData, error: arqError } = await supabase.from('arquitetos').select('*');
            if (arqError) {
                console.error('Erro ao carregar arquitetos:', arqError);
            } else {
                this.arquitetos = arquitetosData || [];
                this.pontuacoes = this.arquitetos.reduce((acc, arq) => {
                    acc[arq.id] = arq.pontos || 0;
                    return acc;
                }, {});
            }

            const { data: pagamentosData, error: pagError } = await supabase.from('pagamentos').select('*');
            if(pagError) {
                console.error('Erro ao carregar pagamentos:', pagError);
            } else {
                this.pagamentos = (pagamentosData || []).reduce((acc, p) => {
                    const dateKey = new Date(p.data_importacao + 'T00:00:00Z').toLocaleDateString('pt-BR');
                    if(!acc[dateKey]) acc[dateKey] = [];
                    acc[dateKey].push(p);
                    return acc;
                }, {});
            }

            const { data: filesData, error: filesError } = await supabase.from('arquivos_importados').select('*');
            if(filesError) {
                console.error('Erro ao carregar arquivos:', filesError);
            } else {
                this.importedFiles = (filesData || []).reduce((acc, f) => {
                     const dateKey = new Date(f.data_importacao + 'T00:00:00Z').toLocaleDateString('pt-BR');
                     acc[dateKey] = { name: f.name, dataUrl: f.dataUrl, id: f.id };
                     return acc;
                }, {});
            }
        }
        
        initEventListeners() {
            // --- Navegação ---
            const menuLinks = document.querySelectorAll('.menu-link');
            const tabViews = document.querySelectorAll('.tab-view');
            menuLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    if (link.id === 'logout-button') return;
                    const targetTab = link.dataset.tab;
                    menuLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    tabViews.forEach(view => view.classList.toggle('active', view.id === `${targetTab}-view`));
                });
            });

            // --- Aba Relatório RT ---
            document.getElementById('rt-file-input').addEventListener('change', this.handleRTFileSelect.bind(this));
            document.getElementById('confirm-rt-mapping-btn').addEventListener('click', this.handleRtMapping.bind(this));
            document.getElementById('cancel-rt-mapping-btn').addEventListener('click', this.closeRtMappingModal.bind(this));
            
            // --- Aba Arquitetos ---
            document.getElementById('add-arquiteto-form').addEventListener('submit', this.handleAddArquiteto.bind(this));
            document.getElementById('arquiteto-file-input').addEventListener('change', this.handleArquitetoFileUpload.bind(this));
            document.getElementById('arquitetos-table-container').addEventListener('click', this.handleArquitetosTableClick.bind(this));
            document.getElementById('edit-arquiteto-form').addEventListener('submit', this.handleEditArquiteto.bind(this));
            document.getElementById('cancel-edit-btn').addEventListener('click', this.closeEditModal.bind(this));
            document.getElementById('add-value-form').addEventListener('submit', this.handleAddValue.bind(this));
            document.getElementById('cancel-add-value-btn').addEventListener('click', this.closeAddValueModal.bind(this));
            document.getElementById('export-csv-btn').addEventListener('click', this.exportArquitetosCSV.bind(this));
            document.getElementById('delete-all-arquitetos-btn').addEventListener('click', this.deleteAllArquitetos.bind(this));
            document.getElementById('rt-percentual').addEventListener('change', this.calculateRT.bind(this));
            document.getElementById('confirm-arquiteto-mapping-btn').addEventListener('click', this.handleArquitetoMapping.bind(this));
            document.getElementById('cancel-arquiteto-mapping-btn').addEventListener('click', this.closeArquitetoMappingModal.bind(this));
            document.getElementById('arquiteto-search-input').addEventListener('input', (e) => this.renderArquitetosTable(e.target.value.trim()));

            // --- Aba Pontuação ---
            document.getElementById('add-pontos-form').addEventListener('submit', this.handleAddPontos.bind(this));

            // --- Aba Comprovantes ---
            const pagamentosContainer = document.getElementById('pagamentos-container');
            pagamentosContainer.addEventListener('change', this.handlePagamentosChange.bind(this));
            pagamentosContainer.addEventListener('click', this.handlePagamentosClick.bind(this));
            document.getElementById('close-comprovante-modal-btn').addEventListener('click', this.closeComprovanteModal.bind(this));
            document.getElementById('pagamento-search-input').addEventListener('input', (e) => this.renderPagamentos(e.target.value.trim()));

            // --- Aba Arquivos Importados ---
            document.getElementById('arquivos-importados-container').addEventListener('click', this.handleArquivosImportadosClick.bind(this));
            
            // --- Aba Consulta Sysled ---
            document.getElementById('sysled-refresh-btn').addEventListener('click', this.fetchSysledData.bind(this));
            document.getElementById('sysled-filter-btn').addEventListener('click', this.renderSysledTable.bind(this));
            document.getElementById('sysled-clear-filter-btn').addEventListener('click', () => {
                document.getElementById('sysled-filter-data-inicio').value = '';
                document.getElementById('sysled-filter-data-fim').value = '';
                document.getElementById('sysled-filter-parceiro').value = '';
                document.getElementById('sysled-filter-excluir-parceiro').value = '';
                this.renderSysledTable();
            });
            document.getElementById('copy-to-rt-btn').addEventListener('click', this.handleCopyToRTClick.bind(this));
            // Listener de delegação para os filtros da tabela
            document.getElementById('sysled-table-container').addEventListener('input', (e) => {
                if (e.target.classList.contains('sysled-column-filter')) {
                    this.renderSysledTable();
                }
            });

            // --- Aba Resultados ---
            document.getElementById('calculate-results-btn').addEventListener('click', this.renderResultados.bind(this));
        }

        renderAll() {
            this.renderArquitetosTable();
            this.renderRankingTable();
            this.populateArquitetoSelect();
            this.renderPagamentos();
            this.renderArquivosImportados();
            this.renderSysledTable();
            this.renderResultados(); // Adicionado para carregar os resultados
        }
        
        // --- MÉTODO DA NOVA ABA: RESULTADOS ---
        renderResultados() {
            // 1. Soma de todas as RTs da aba de pagamentos, que já tem o valor fixo
            const totalRTs = Object.values(this.pagamentos).flat().reduce((sum, pagamento) => {
                return sum + this.parseCurrency(pagamento.rt_valor || 0);
            }, 0);
            document.getElementById('total-rt').textContent = this.formatCurrency(totalRTs);

            // 2. Soma dos valores dos pedidos da aba de arquitetos
            const totalPedidosValor = this.arquitetos.reduce((sum, arquiteto) => {
                return sum + this.parseCurrency(arquiteto.valorVendasTotal || 0);
            }, 0);
            document.getElementById('total-pedidos-valor').textContent = this.formatCurrency(totalPedidosValor);

            // 3. Soma da quantidade de pedidos da aba de arquitetos
            const totalPedidosQuantidade = this.arquitetos.reduce((sum, arquiteto) => {
                return sum + (arquiteto.salesCount || 0);
            }, 0);
            document.getElementById('total-pedidos-quantidade').textContent = totalPedidosQuantidade;

            // 4. Calcula o pedido médio
            const pedidoMedio = totalPedidosQuantidade > 0 ? totalPedidosValor / totalPedidosQuantidade : 0;
            document.getElementById('pedido-medio').textContent = this.formatCurrency(pedidoMedio);
        }

        // --- MÉTODOS DA ABA: CONSULTA SYSLED ---

        async fetchSysledData() {
            const container = document.getElementById('sysled-table-container');
            container.innerHTML = `<p class="text-center text-gray-500 py-8">Buscando dados na API Sysled... <i class="fas fa-spinner fa-spin"></i></p>`;
            
            try {
                const apiUrl = 'https://integration.sysled.com.br/n8n/api/?v_crm_oportunidades_propostas_up180dd=null';
                const apiKey = 'e4b6f9082f1b8a1f37ad5b56e637f3ec719ec8f0b6acdd093972f9c5bb29b9ed';

                const response = await fetch(apiUrl, {
                    headers: {
                        'Authorization': apiKey,
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                this.sysledData = data;
                console.log("Dados da API Sysled carregados:", this.sysledData);

            } catch (error) {
                console.error("Erro ao buscar dados da API Sysled:", error);
                container.innerHTML = `<p class="text-center text-red-500 py-8">Erro ao carregar dados da API. Verifique o console para mais detalhes.</p>`;
            } finally {
                this.renderSysledTable();
            }
        }
        
        formatApiDateToBR(dateString) {
            if (!dateString || typeof dateString !== 'string') return '';
            const datePart = dateString.split('T')[0];
            const parts = datePart.split('-');
            if (parts.length !== 3) return dateString; 
            const [year, month, day] = parts;
            return `${day}/${month}/${year}`;
        }

        formatApiNumberToBR(value) {
            if (value === null || value === undefined || value === '') return '';
            const number = this.parseApiNumber(value);
            if (isNaN(number)) return value;
            return number.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        renderSysledTable() {
            const container = document.getElementById('sysled-table-container');
            
            if (this.sysledData.length === 0) {
                 container.innerHTML = `<div class="text-center text-gray-500 py-8"><p>Clique em "Atualizar Dados" para carregar as informações da API Sysled.</p></div>`
                 return;
            }

            const dataInicio = document.getElementById('sysled-filter-data-inicio').value;
            const dataFim = document.getElementById('sysled-filter-data-fim').value;
            const parceiro = document.getElementById('sysled-filter-parceiro').value.toLowerCase();
            const excluirParceiroInput = document.getElementById('sysled-filter-excluir-parceiro').value;

            
            const columnFilters = {};
            container.querySelectorAll('.sysled-column-filter').forEach(input => {
                if (input.value) {
                    columnFilters[input.dataset.column] = input.value.toLowerCase();
                }
            });

            let dataToRender = [...this.sysledData];

            if (excluirParceiroInput) {
                const excludedIds = excluirParceiroInput.split(/[\s,]+/).map(id => id.trim()).filter(id => id);
                if (excludedIds.length > 0) {
                    const partnerIdField = Object.keys(dataToRender[0]).find(k => k.toLowerCase().includes('idparceiro') || k.toLowerCase().includes('id_parceiro'));
                    if (partnerIdField) {
                        dataToRender = dataToRender.filter(row => !excludedIds.includes(String(row[partnerIdField])));
                    }
                }
            }
            
            const dateField = Object.keys(dataToRender[0]).find(k => k.toLowerCase().includes('data'));
            if (dataInicio && dateField) {
                dataToRender = dataToRender.filter(row => row[dateField] && row[dateField].split('T')[0] >= dataInicio);
            }
            if (dataFim && dateField) {
                dataToRender = dataToRender.filter(row => row[dateField] && row[dateField].split('T')[0] <= dataFim);
            }
            if (parceiro) {
                const partnerNameField = Object.keys(dataToRender[0]).find(k => k.toLowerCase().includes('parceiro') || k.toLowerCase().includes('arquiteto'));
                const partnerIdField = Object.keys(dataToRender[0]).find(k => k.toLowerCase().includes('idparceiro') || k.toLowerCase().includes('id_parceiro'));
                dataToRender = dataToRender.filter(row => 
                    (partnerNameField && row[partnerNameField] && row[partnerNameField].toLowerCase().includes(parceiro)) ||
                    (partnerIdField && row[partnerIdField] && String(row[partnerIdField]).toLowerCase().includes(parceiro))
                );
            }

            Object.keys(columnFilters).forEach(column => {
                const filterValue = columnFilters[column];
                dataToRender = dataToRender.filter(row => 
                    row[column] !== null && row[column] !== undefined && String(row[column]).toLowerCase().includes(filterValue)
                );
            });

            this.sysledFilteredData = dataToRender;

            const headers = Object.keys(this.sysledData[0]);
            const headerHtml = headers.map(h => `<th class="p-2 text-left text-xs uppercase bg-gray-100 sticky top-0 z-10">${h.replace(/_/g, ' ')}</th>`).join('');
            const filterHtml = headers.map(h => `
                <th class="p-1 bg-gray-100 sticky top-8 z-10">
                    <input type="text" class="sysled-column-filter w-full p-1 border rounded-md text-sm" placeholder="Filtrar..."
                           data-column="${h}" value="${columnFilters[h] ? columnFilters[h].replace(/"/g, '&quot;') : ''}">
                </th>`).join('');

            let rowsHtml = '';
            if (this.sysledFilteredData.length === 0) {
                rowsHtml = `<tr><td colspan="${headers.length}" class="text-center text-gray-500 py-8">Nenhum resultado encontrado.</td></tr>`;
            } else {
                rowsHtml = this.sysledFilteredData.map(row => {
                    const cells = headers.map(h => {
                        let cellValue = row[h];
                        const lowerCaseHeader = h.toLowerCase();
                        if (lowerCaseHeader.includes('data')) {
                            cellValue = this.formatApiDateToBR(cellValue);
                        } else if (lowerCaseHeader.includes('valor') || lowerCaseHeader.includes('total') || lowerCaseHeader.includes('valornota')) {
                            if (cellValue !== null && !isNaN(Number(String(cellValue)))) {
                                cellValue = this.formatApiNumberToBR(cellValue);
                            }
                        }
                        return `<td class="p-2">${cellValue === null || cellValue === undefined ? '' : cellValue}</td>`;
                    }).join('');
                    return `<tr class="border-b text-sm hover:bg-gray-50">${cells}</tr>`;
                }).join('');
            }
            
            container.innerHTML = `
                <div class="max-h-[65vh] overflow-auto">
                    <table class="w-full min-w-max">
                        <thead class="bg-gray-100">
                            <tr>${headerHtml}</tr>
                            <tr>${filterHtml}</tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                </div>`;
        }
        
        async handleCopyToRTClick() {
            if (this.sysledFilteredData.length === 0) {
                alert('Não há dados filtrados para copiar. Por favor, filtre os dados primeiro ou atualize a consulta.');
                return;
            }

            this.isSysledImport = true;
            this.tempRTData = this.sysledFilteredData;

            alert(`${this.tempRTData.length} linha(s) selecionada(s). Agora, confirme o mapeamento para gerar o relatório de RT.`);
            const headers = this.tempRTData.length > 0 ? Object.keys(this.tempRTData[0]) : [];
            this.openRtMappingModal(headers);
            document.querySelector('.menu-link[data-tab="relatorio-rt"]').click();
        }

        // --- MÉTODOS EXISTENTES (AJUSTADOS E COMPLETOS) ---

        handleRTFileSelect(event) {
            this.isSysledImport = false; // Dados são de um arquivo, não da Sysled
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('rt-file-name').textContent = `Arquivo: ${file.name}`;
            const readerProcess = new FileReader();
            readerProcess.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                this.tempRTData = XLSX.utils.sheet_to_json(worksheet, { raw: false });
                const headers = this.tempRTData.length > 0 ? Object.keys(this.tempRTData[0]) : [];
                this.openRtMappingModal(headers);
            };
            readerProcess.readAsArrayBuffer(file);
        }

        openRtMappingModal(headers) {
            const form = document.getElementById('rt-mapping-form');
            const modal = document.getElementById('rt-mapping-modal');
            form.innerHTML = '';
            
            const requiredFields = { 
                id_prevenda: 'ID Prevenda', 
                data_venda: 'Data Venda', 
                nome_cliente: 'Nome Cliente', 
                valor_venda: 'Valor Venda', 
                executivo: 'Executivo', 
                id_parceiro: 'ID Parceiro', 
                parceiro: 'Parceiro', 
                loja: 'Loja' 
            };
            
            const autoMapping = {
                id_prevenda: 'idPedido',
                data_venda: 'dataFinalizacaoPrevenda',
                nome_cliente: 'clienteFantasia',
                valor_venda: 'valorNota',
                executivo: 'consultor',
                id_parceiro: 'idParceiro',
                parceiro: 'parceiro',
                loja: 'idEmpresa'
            };
            
            for (const key in requiredFields) {
                const label = requiredFields[key];
                const selectOptions = headers.map(h => `<option value="${h}">${h}</option>`).join('');
                form.innerHTML += `<div class="grid grid-cols-2 gap-4 items-center"><label for="map-${key}" class="font-medium text-gray-700">${label}</label><select id="map-${key}" name="${key}" class="w-full p-2 bg-gray-50 border rounded-lg"><option value="">Selecione...</option>${selectOptions}</select></div>`;
            }

            if(this.isSysledImport){
                for (const key in autoMapping) {
                    if (requiredFields[key]) {
                        const selectElement = form.querySelector(`#map-${key}`);
                        if (selectElement && headers.includes(autoMapping[key])) {
                            selectElement.value = autoMapping[key];
                        }
                    }
                }
            }

            modal.classList.add('flex');
        }

        closeRtMappingModal() {
            document.getElementById('rt-mapping-modal').classList.remove('flex');
            document.getElementById('rt-file-input').value = '';
            document.getElementById('rt-file-name').textContent = '';
        }

        async handleRtMapping() {
            const mapping = {};
            document.getElementById('rt-mapping-form').querySelectorAll('select').forEach(s => { mapping[s.name] = s.value; });
            
            const processedData = this.tempRTData.map(row => {
                const newRow = {};
                for (const key in mapping) { if (mapping[key]) newRow[key] = row[mapping[key]]; }
                return newRow;
            });
            
            if (this.isSysledImport) {
                processedData.forEach(item => {
                    const valorVenda = this.parseApiNumber(item.valor_venda);
                    item.valor_venda = valorVenda;
                });
            }
            
            if (processedData.length > 0) {
                await this.processRTData(processedData);
                // Gera o relatório para impressão com os dados recém processados, que já contêm o rt_valor
                const dataForPrint = await this.getDataForPrint(processedData);
                this.generateRTPrint(dataForPrint);
            } else {
                alert("Nenhum dado válido no arquivo.");
            }
            
            this.closeRtMappingModal();
        }

        async getDataForPrint(processedData) {
            const partnerIds = [...new Set(processedData.map(p => p.id_parceiro))];
            const pagamentosDoDia = [];

            const todayKey = new Date().toLocaleDateString('pt-BR');
            if (this.pagamentos[todayKey]) {
                const prevendaIds = processedData.map(p => String(p.id_prevenda));
                this.pagamentos[todayKey].forEach(p => {
                    if (prevendaIds.includes(String(p.id_prevenda))) {
                        pagamentosDoDia.push(p);
                    }
                });
            }
            return pagamentosDoDia;
        }


        async processRTData(data) {
            const todayKey = new Date().toLocaleDateString('pt-BR');
            const todayDB = new Date().toISOString().slice(0, 10);

            if (this.isSysledImport) {
                const dataUrl = this.jsonToXLSXDataURL(data);
                const fileName = `importacao_sysled_${todayKey.replace(/\//g, '-')}.xlsx`;
                const { data: fileData, error: fileError } = await supabase.from('arquivos_importados').insert({
                    data_importacao: todayDB, name: fileName, dataUrl: dataUrl
                }).select().single();

                if(fileError) {
                    console.error("Erro ao salvar arquivo da Sysled:", fileError);
                } else {
                    this.importedFiles[todayKey] = { name: fileData.name, dataUrl: fileData.dataUrl, id: fileData.id };
                }
            } else {
                const fileInput = document.getElementById('rt-file-input');
                const file = fileInput.files[0];
                
                if(file) {
                     const dataUrl = await this.fileToBase64(file);
                     const { data: fileData, error: fileError } = await supabase.from('arquivos_importados').insert({
                         data_importacao: todayDB, name: file.name, dataUrl: dataUrl
                     }).select().single();
                     if(fileError) console.error("Erro ao salvar arquivo:", fileError);
                     else this.importedFiles[todayKey] = { name: fileData.name, dataUrl: fileData.dataUrl, id: fileData.id };
                }
            }

            const pagamentosParaInserir = [];
            for (const record of data) {
                const partnerId = String(record.id_parceiro);
                const arquiteto = this.arquitetos.find(a => a.id === partnerId);
                const valorVenda = this.parseCurrency(record.valor_venda);

                if (arquiteto) {
                    arquiteto.valorVendasTotal = (arquiteto.valorVendasTotal || 0) + valorVenda;
                    arquiteto.salesCount = (arquiteto.salesCount || 0) + 1;
                    const newPoints = Math.floor(valorVenda / 1000);
                    if (newPoints > 0) {
                        this.pontuacoes[arquiteto.id] = (this.pontuacoes[arquiteto.id] || 0) + newPoints;
                        arquiteto.pontos = this.pontuacoes[arquiteto.id];
                    }
                    await supabase.from('arquitetos').update({
                        valorVendasTotal: arquiteto.valorVendasTotal,
                        salesCount: arquiteto.salesCount,
                        pontos: arquiteto.pontos
                    }).eq('id', partnerId);
                }
                
                let percentualRT = 0.05;
                if (arquiteto && arquiteto.rtPercentual > 0) {
                    percentualRT = arquiteto.rtPercentual;
                }
                const rtValue = valorVenda * percentualRT;

                if (record.id_prevenda && !(this.pagamentos[todayKey] || []).some(p => p.id_prevenda === record.id_prevenda)) {
                    pagamentosParaInserir.push({
                        data_importacao: todayDB, id_prevenda: String(record.id_prevenda), id_parceiro: partnerId,
                        parceiro: record.parceiro, valor_venda: valorVenda, rt_valor: rtValue, pago: false
                    });
                }
            }
            
            if (pagamentosParaInserir.length > 0) {
                const { data: inserted, error } = await supabase.from('pagamentos').insert(pagamentosParaInserir).select();
                if (error) console.error("Erro ao inserir pagamentos:", error);
                else {
                    if(!this.pagamentos[todayKey]) this.pagamentos[todayKey] = [];
                    this.pagamentos[todayKey].push(...inserted);
                }
            }
            
            this.renderAll();
            this.isSysledImport = false;
        }

        handleArquitetosTableClick(e) {
            const idLink = e.target.closest('.id-link');
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const addValueBtn = e.target.closest('.add-value-btn');
            if (idLink) { e.preventDefault(); this.openEditModal(idLink.dataset.id); }
            if (editBtn) this.openEditModal(editBtn.dataset.id);
            if (deleteBtn) this.deleteArquiteto(deleteBtn.dataset.id);
            if (addValueBtn) this.openAddValueModal(addValueBtn.dataset.id);
        }
        
        async handleAddArquiteto(e) {
            e.preventDefault();
            const id = document.getElementById('arquiteto-id').value;
            if (this.arquitetos.some(a => a.id === id)) { alert('ID já existe.'); return; }
            
            const newArquiteto = {
                id, nome: document.getElementById('arquiteto-nome').value, email: document.getElementById('arquiteto-email').value,
                telefone: document.getElementById('arquiteto-telefone').value, pix: document.getElementById('arquiteto-pix').value,
                salesCount: 0, valorVendasTotal: 0, pontos: 0, rtPercentual: 0.05
            };
            
            const { data, error } = await supabase.from('arquitetos').insert(newArquiteto).select().single();
            if (error) { alert('Erro: ' + error.message); }
            else {
                this.arquitetos.push(data);
                this.pontuacoes[data.id] = data.pontos;
                this.renderAll();
                e.target.reset();
            }
        }
        
        handleArquitetoFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            document.getElementById('file-name-arquitetos').textContent = `Arquivo: ${file.name}`;
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                this.tempArquitetoData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { raw: false });
                const headers = this.tempArquitetoData.length > 0 ? Object.keys(this.tempArquitetoData[0]) : [];
                this.openArquitetoMappingModal(headers);
            };
            reader.readAsArrayBuffer(file);
        }

        openArquitetoMappingModal(headers) {
            const form = document.getElementById('arquiteto-mapping-form');
            form.innerHTML = '';
            const requiredFields = { id: 'ID', nome: 'Nome', email: 'Email', telefone: 'Telefone', chave_pix: 'Chave PIX' };
            for (const key in requiredFields) {
                const label = requiredFields[key];
                const selectOptions = headers.map(h => `<option value="${h}">${h}</option>`).join('');
                form.innerHTML += `<div class="grid grid-cols-2 gap-4 items-center"><label class="font-medium text-gray-700">${label}</label><select name="${key}" class="w-full p-2 bg-gray-50 border rounded-lg"><option value="">Selecione...</option>${selectOptions}</select></div>`;
            }
            document.getElementById('arquiteto-mapping-modal').classList.add('flex');
        }

        closeArquitetoMappingModal() {
            document.getElementById('arquiteto-mapping-modal').classList.remove('flex');
            document.getElementById('arquiteto-file-input').value = '';
            document.getElementById('file-name-arquitetos').textContent = '';
        }

        async handleArquitetoMapping() {
            const mapping = {};
            document.getElementById('arquiteto-mapping-form').querySelectorAll('select').forEach(s => { mapping[s.name] = s.value; });
            const novosArquitetos = this.tempArquitetoData.filter(row => {
                const id = row[mapping.id];
                return id && !this.arquitetos.some(a => a.id === id.toString());
            }).map(row => ({
                id: String(row[mapping.id]), nome: row[mapping.nome] || '', email: row[mapping.email] || '',
                telefone: row[mapping.telefone] || '', pix: row[mapping.chave_pix] || '',
                salesCount: 0, valorVendasTotal: 0, pontos: 0, rtPercentual: 0.05
            }));
            
            if (novosArquitetos.length > 0) {
                const { error } = await supabase.from('arquitetos').insert(novosArquitetos);
                if (error) { alert("Erro ao importar: " + error.message); }
                else {
                    alert(`${novosArquitetos.length} novos arquitetos importados.`);
                    await this.loadData();
                    this.renderAll();
                }
            } else {
                alert('Nenhum arquiteto novo para importar.');
            }
            this.closeArquitetoMappingModal();
        }
        
        openEditModal(id) {
            const arquiteto = this.arquitetos.find(a => a.id === id);
            if (!arquiteto) return;
            document.getElementById('edit-arquiteto-original-id').value = arquiteto.id;
            document.getElementById('edit-arquiteto-id').textContent = arquiteto.id;
            document.getElementById('edit-arquiteto-nome').value = arquiteto.nome;
            document.getElementById('edit-arquiteto-email').value = arquiteto.email;
            document.getElementById('edit-arquiteto-telefone').value = arquiteto.telefone;
            document.getElementById('edit-arquiteto-pix').value = arquiteto.pix;
            document.getElementById('edit-arquiteto-vendas').value = arquiteto.salesCount || 0;
            document.getElementById('rt-valor-vendas').textContent = this.formatCurrency(arquiteto.valorVendasTotal || 0);
            document.getElementById('rt-percentual').value = arquiteto.rtPercentual || 0.05;
            document.getElementById('edit-arquiteto-modal').classList.add('flex');
            this.calculateRT();
        }

        closeEditModal() { document.getElementById('edit-arquiteto-modal').classList.remove('flex'); }
        
        calculateRT() {
            const valorTotal = this.parseCurrency(document.getElementById('rt-valor-vendas').textContent);
            const percentual = parseFloat(document.getElementById('rt-percentual').value);
            document.getElementById('rt-valor-calculado').textContent = this.formatCurrency(valorTotal * percentual);
        }

        async handleEditArquiteto(e) {
            e.preventDefault();
            const originalId = document.getElementById('edit-arquiteto-original-id').value;
            const updatedData = {
                nome: document.getElementById('edit-arquiteto-nome').value,
                email: document.getElementById('edit-arquiteto-email').value,
                telefone: document.getElementById('edit-arquiteto-telefone').value,
                pix: document.getElementById('edit-arquiteto-pix').value,
                salesCount: parseInt(document.getElementById('edit-arquiteto-vendas').value, 10) || 0,
                rtPercentual: parseFloat(document.getElementById('rt-percentual').value)
            };
            const { data, error } = await supabase.from('arquitetos').update(updatedData).eq('id', originalId).select().single();
            if (error) { alert("Erro ao salvar: " + error.message); }
            else {
                const index = this.arquitetos.findIndex(a => a.id === originalId);
                this.arquitetos[index] = data;
                this.renderAll();
                this.closeEditModal();
            }
        }

        async deleteArquiteto(id) {
            if (confirm(`Tem certeza que deseja apagar o arquiteto com ID ${id}?`)) {
                const { error } = await supabase.from('arquitetos').delete().eq('id', id);
                if (error) { alert("Erro ao apagar: " + error.message); }
                else {
                    this.arquitetos = this.arquitetos.filter(a => a.id !== id);
                    delete this.pontuacoes[id];
                    this.renderAll();
                }
            }
        }

        async deleteAllArquitetos() {
            if (confirm('TEM CERTEZA? Isto apagará TODOS os arquitetos.')) {
                const { error } = await supabase.from('arquitetos').delete().neq('id', 'placeholder');
                if (error) { alert("Erro ao apagar: " + error.message); }
                else {
                    this.arquitetos = [];
                    this.pontuacoes = {};
                    this.renderAll();
                }
            }
        }

        openAddValueModal(id) {
            const arquiteto = this.arquitetos.find(a => a.id === id);
            if (!arquiteto) return;
            document.getElementById('add-value-modal-title').textContent = `Adicionar Valor para ${arquiteto.nome}`;
            document.getElementById('add-value-arquiteto-id').value = id;
            document.getElementById('add-value-modal').classList.add('flex');
        }

        closeAddValueModal() {
            document.getElementById('add-value-modal').classList.remove('flex');
            document.getElementById('add-value-form').reset();
        }

        async handleAddValue(e) {
            e.preventDefault();
            const id = document.getElementById('add-value-arquiteto-id').value;
            const valueToAdd = parseFloat(document.getElementById('add-value-input').value);
            const arquiteto = this.arquitetos.find(a => a.id === id);
            if (arquiteto && !isNaN(valueToAdd)) {
                const newTotal = (arquiteto.valorVendasTotal || 0) + valueToAdd;
                const newPoints = (this.pontuacoes[id] || 0) + Math.floor(valueToAdd / 1000);
                const { data: updatedArquiteto, error } = await supabase.from('arquitetos').update({ valorVendasTotal: newTotal, pontos: newPoints }).eq('id', id).select().single();
                if(error) { alert("Erro ao adicionar valor: " + error.message); }
                else {
                    const index = this.arquitetos.findIndex(a => a.id === id);
                    this.arquitetos[index] = updatedArquiteto;
                    this.pontuacoes[id] = updatedArquiteto.pontos;
                    this.renderAll();
                    this.closeAddValueModal();
                }
            }
        }

        exportArquitetosCSV() {
            if (this.arquitetos.length === 0) { alert("Não há dados para exportar."); return; }
            const data = this.arquitetos.map(a => ({
                id: a.id, nome: a.nome, email: a.email, telefone: a.telefone, pix: a.pix,
                quantidade_vendas: a.salesCount || 0, valor_total_vendas: a.valorVendasTotal || 0,
                pontos: this.pontuacoes[a.id] || 0
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Arquitetos");
            XLSX.writeFile(wb, "cadastro_arquitetos.xlsx");
        }

        async handleAddPontos(e) {
            e.preventDefault();
            const arquitetoId = document.getElementById('arquiteto-select').value;
            const pontos = parseInt(document.getElementById('pontos-valor').value, 10);
            const arquiteto = this.arquitetos.find(a => a.id === arquitetoId);
            if (arquiteto && !isNaN(pontos)) {
                const newPoints = (this.pontuacoes[arquitetoId] || 0) + pontos;
                const { error } = await supabase.from('arquitetos').update({ pontos: newPoints }).eq('id', arquitetoId);
                if (error) {
                    alert("Erro ao atualizar pontos: " + error.message);
                } else {
                    this.pontuacoes[arquitetoId] = newPoints;
                    arquiteto.pontos = newPoints;
                    this.renderRankingTable();
                    e.target.reset();
                }
            }
        }
        
        handlePagamentosChange(e) {
            if (e.target.matches('.pagamento-status')) {
                const { date, id } = e.target.dataset;
                this.updatePagamentoStatus(date, id, e.target.checked);
            }
            if (e.target.matches('.comprovante-input')) {
                const { date, id } = e.target.dataset;
                this.handleComprovanteUpload(date, id, e.target.files[0]);
            }
        }

        handlePagamentosClick(e) {
            if (e.target.closest('.view-comprovante-btn')) {
                e.preventDefault();
                const { date, id } = e.target.closest('.view-comprovante-btn').dataset;
                this.openComprovanteModal(date, id);
            }
            if (e.target.closest('.delete-pagamentos-btn')) {
                this.deletePagamentosGroup(e.target.closest('.delete-pagamentos-btn').dataset.date);
            }
             if (e.target.closest('.download-report-btn')) {
                const { date } = e.target.closest('.download-report-btn').dataset;
                this.generateRTPrint(this.pagamentos[date] || []);
            }
            if (e.target.closest('.download-xlsx-btn')) {
                const { date } = e.target.closest('.download-xlsx-btn').dataset;
                this.exportPagamentosXLSX(date);
            }
        }

        async updatePagamentoStatus(date, prevendaId, isChecked) {
            const pagamento = this.pagamentos[date]?.find(p => p.id_prevenda.toString() === prevendaId);
            if (pagamento) {
                const { error } = await supabase.from('pagamentos').update({ pago: isChecked }).eq('id', pagamento.id);
                if (error) alert("Erro ao atualizar status: " + error.message);
                else pagamento.pago = isChecked;
            }
        }

        async handleComprovanteUpload(date, prevendaId, file) {
            if (!file) return;
            const pagamento = this.pagamentos[date]?.find(p => p.id_prevenda.toString() === prevendaId);
            if(pagamento){
                 const dataUrl = await this.fileToBase64(file);
                 pagamento.comprovante = { name: file.name, url: dataUrl };
                 const { error } = await supabase.from('pagamentos').update({ comprovante: pagamento.comprovante }).eq('id', pagamento.id);
                 if(error) alert("Erro ao salvar comprovante: " + error.message);
                 else this.renderPagamentos();
            }
        }
        
        async deletePagamentosGroup(date) {
            if (confirm(`Tem certeza que deseja apagar os pagamentos do dia ${date}?`)) {
                const dateForDB = date.split('/').reverse().join('-');
                const { error } = await supabase.from('pagamentos').delete().eq('data_importacao', dateForDB);
                if (error) { alert("Erro ao apagar pagamentos: " + error.message); }
                else {
                    delete this.pagamentos[date];
                    this.renderPagamentos();
                }
            }
        }

        openComprovanteModal(date, id) {
            const pagamento = this.pagamentos[date]?.find(p => p.id_prevenda.toString() === id);
            if (!pagamento) return;
            document.getElementById('comprovante-modal-title').textContent = `Detalhes: ${pagamento.id_prevenda}`;
            
            document.getElementById('comprovante-valor-rt').textContent = this.formatCurrency(pagamento.rt_valor || 0);
            
            const imgContainer = document.getElementById('comprovante-img-container');
            if (pagamento.comprovante && pagamento.comprovante.url) {
                imgContainer.innerHTML = `<img src="${pagamento.comprovante.url}" alt="${pagamento.comprovante.name}" class="max-w-full max-h-96 object-contain">`;
            } else {
                imgContainer.innerHTML = `<p class="text-gray-500">Nenhum comprovante anexado.</p>`;
            }
            document.getElementById('comprovante-modal').classList.add('flex');
        }

        closeComprovanteModal() {
            document.getElementById('comprovante-modal').classList.remove('flex');
        }
        
        handleArquivosImportadosClick(e) {
            const downloadBtn = e.target.closest('.download-arquivo-btn');
            if (downloadBtn) {
                e.preventDefault();
                const { date } = downloadBtn.dataset;
                this.downloadImportedFile(date);
            }
        }

        downloadImportedFile(date) {
            const fileInfo = this.importedFiles[date];
            if (fileInfo) {
                const link = document.createElement('a');
                link.href = fileInfo.dataUrl;
                link.download = fileInfo.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        renderArquitetosTable(filter = '') {
            const container = document.getElementById('arquitetos-table-container');
            let filteredArquitetos = this.arquitetos;
            if (filter) {
                const lowerCaseFilter = filter.toLowerCase();
                filteredArquitetos = this.arquitetos.filter(a => 
                    a.id.toLowerCase().includes(lowerCaseFilter) || 
                    a.nome.toLowerCase().includes(lowerCaseFilter)
                );
            }
            if (filteredArquitetos.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Nenhum arquiteto encontrado.</p>`;
                return;
            }
            const rows = filteredArquitetos.map(a => `
                <tr class="border-b text-sm">
                    <td class="p-2"><a href="#" class="id-link text-blue-600 hover:underline" data-id="${a.id}">${a.id}</a></td>
                    <td class="p-2">${a.nome}</td><td class="p-2">${a.email}</td>
                    <td class="p-2 text-center">${a.salesCount || 0}</td>
                    <td class="p-2 text-right">${this.formatCurrency(a.valorVendasTotal || 0)}</td>
                    <td class="p-2 text-center">
                        <button class="add-value-btn text-green-500 hover:text-green-700" title="Adicionar Valor" data-id="${a.id}"><i class="fas fa-dollar-sign"></i></button>
                        <button class="edit-btn text-blue-500 hover:text-blue-700 ml-4" title="Editar" data-id="${a.id}"><i class="fas fa-edit"></i></button>
                        <button class="delete-btn text-red-500 hover:text-red-700 ml-4" title="Apagar" data-id="${a.id}"><i class="fas fa-trash"></i></button>
                    </td></tr>`).join('');
            container.innerHTML = `<table class="w-full"><thead><tr class="bg-gray-100 text-xs uppercase"><th class="p-2 text-left">ID</th><th class="p-2 text-left">Nome</th><th class="p-2 text-left">Email</th><th class="p-2 text-center">Vendas</th><th class="p-2 text-right">Valor Vendas</th><th class="p-2 text-center">Ações</th></tr></thead><tbody>${rows}</tbody></table>`;
        }

        renderRankingTable() {
            const container = document.getElementById('ranking-table-container');
            const ranking = this.arquitetos.map(a => ({ ...a, pontos: this.pontuacoes[a.id] || 0 })).sort((a, b) => b.pontos - a.pontos);
            if (ranking.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Nenhum arquiteto para exibir no ranking.</p>`; return;
            }
            const rows = ranking.map(a => `<tr class="border-b text-sm"><td class="p-2">${a.id}</td><td class="p-2">${a.nome}</td><td class="p-2 font-bold">${a.pontos}</td></tr>`).join('');
            container.innerHTML = `<table class="w-full"><thead><tr class="bg-gray-100 text-xs uppercase"><th class="p-2 text-left">ID</th><th class="p-2 text-left">Nome</th><th class="p-2 text-left">Pontos</th></tr></thead><tbody>${rows}</tbody></table>`;
        }
        
        populateArquitetoSelect() {
            const select = document.getElementById('arquiteto-select');
            select.innerHTML = '<option value="">Selecione um arquiteto</option>';
            this.arquitetos.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(a => {
                select.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
            });
        }
        
        renderPagamentos(filter = '') {
            const container = document.getElementById('pagamentos-container');
            container.innerHTML = '';
            const dates = Object.keys(this.pagamentos).sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));

            if (dates.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Nenhum relatório de RT foi importado ainda.</p>`; return;
            }

            let hasResults = false;
            dates.forEach(date => {
                let pagamentosDoDia = this.pagamentos[date];
                if (filter) {
                    pagamentosDoDia = pagamentosDoDia.filter(p => p.id_parceiro && p.id_parceiro.toString().includes(filter));
                }

                if (pagamentosDoDia.length > 0) {
                    hasResults = true;
                    const rowsHtml = pagamentosDoDia.map(p => {
                        const rtSalva = this.parseCurrency(p.rt_valor || 0);

                        return `
                            <tr class="border-b text-sm">
                                <td class="p-2"><a href="#" class="view-comprovante-btn text-blue-600 hover:underline" data-date="${date}" data-id="${p.id_prevenda}">${p.id_prevenda}</a></td>
                                <td class="p-2">${p.parceiro}</td>
                                <td class="p-2 text-right font-semibold">${this.formatCurrency(rtSalva)}</td>
                                <td class="p-2 text-center"><input type="checkbox" class="pagamento-status h-5 w-5" data-date="${date}" data-id="${p.id_prevenda}" ${p.pago ? 'checked' : ''}></td>
                                <td class="p-2"><input type="file" class="comprovante-input text-xs" data-date="${date}" data-id="${p.id_prevenda}"></td>
                            </tr>`;
                    }).join('');

                    container.innerHTML += `
                        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Pagamento de ${date}</h2>
                                <div class="flex items-center gap-2">
                                    <button class="download-report-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg text-xs" data-date="${date}">Baixar Relatório</button>
                                    <button class="download-xlsx-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-lg text-xs" data-date="${date}">Baixar XLSX</button>
                                    <button class="delete-pagamentos-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-xs" data-date="${date}">Excluir Tudo</button>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead><tr class="bg-gray-100 text-xs uppercase"><th class="p-2 text-left">ID Prevenda</th><th class="p-2 text-left">Parceiro</th><th class="p-2 text-right">Valor RT</th><th class="p-2 text-center">Pago</th><th class="p-2 text-left">Anexar Comprovante</th></tr></thead>
                                    <tbody>${rowsHtml}</tbody>
                                </table>
                            </div>
                        </div>`;
                }
            });
            if (!hasResults) {
                container.innerHTML = `<p class="text-center text-gray-500">Nenhum pagamento encontrado para o ID informado.</p>`;
            }
        }
        
        renderArquivosImportados() {
            const container = document.getElementById('arquivos-importados-container');
            container.innerHTML = '';
            const dates = Object.keys(this.importedFiles).sort((a,b) => new Date(b.split('/').reverse().join('-')) - new Date(a.split('/').reverse().join('-')));
            if (dates.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">Nenhum arquivo foi importado ainda.</p>`; return;
            }
            dates.forEach(date => {
                const fileInfo = this.importedFiles[date];
                container.innerHTML += `
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold text-lg">Importação de ${date}</h3>
                                <p class="text-sm text-gray-500 mt-1">${fileInfo.name}</p>
                            </div>
                            <button class="download-arquivo-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm flex items-center gap-2" data-date="${date}">
                                <i class="fas fa-download"></i> Baixar
                            </button>
                        </div>
                    </div>`;
            });
        }
        
        // --- MÉTODOS UTILITÁRIOS ---
        fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        jsonToXLSXDataURL(jsonData) {
            const ws = XLSX.utils.json_to_sheet(jsonData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Sysled Import");
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
            return "data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64," + wbout;
        }

        parseApiNumber(value) {
            if (value === null || value === undefined) return 0;
            return Number(String(value).replace(',', '.')) || 0;
        }

        parseCurrency(value) {
            if (typeof value === 'number') return value;
            if (typeof value !== 'string' || value === null) return 0;
            return parseFloat(String(value).replace(/R\$\s?/, '').replace(/\./g, '').replace(',', '.')) || 0;
        }

        formatCurrency(value) {
            const number = this.parseCurrency(value);
            return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        generateRTPrint(data) {
            const groupedById = {}; 
            data.forEach(record => {
                const partnerId = record.id_parceiro || 'N/A';
                
                if (!groupedById[partnerId]) { 
                    groupedById[partnerId] = { 
                        partnerName: record.parceiro || 'N/A', 
                        totalVenda: 0, 
                        totalRt: 0, 
                        salesCount: 0 
                    }; 
                }
                const vendaValue = this.parseCurrency(record.valor_venda);
                const rtValue = this.parseCurrency(record.rt_valor);

                groupedById[partnerId].totalVenda += vendaValue;
                groupedById[partnerId].totalRt += rtValue;
                groupedById[partnerId].salesCount++;
            });

            const grandTotalRt = Object.values(groupedById).reduce((sum, group) => sum + group.totalRt, 0);

            const sortedPartners = Object.keys(groupedById).sort((a, b) => groupedById[a].partnerName.localeCompare(groupedById[b].partnerName));
            const tableRowsHtml = sortedPartners.map(id => {
                const d = groupedById[id];
                return `<tr class="border-b text-sm"><td class="p-2">${id}</td><td class="p-2">${d.partnerName}</td><td class="p-2 text-right">${this.formatCurrency(d.totalVenda)}</td><td class="p-2 text-right">${this.formatCurrency(d.totalRt)}</td><td class="p-2 text-center">${d.salesCount}</td></tr>`;
            }).join('');
            const reportTableHtml = `<div class="report-section"><table class="w-full"><thead><tr class="bg-gray-100 text-xs uppercase"><th class="p-2 text-left">ID Parceiro</th><th class="p-2 text-left">Parceiro</th><th class="p-2 text-right">Venda</th><th class="p-2 text-right">RT</th><th class="p-2 text-center">Qtd. Vendas</th></tr></thead><tbody>${tableRowsHtml}</tbody></table></div>`;
            const printTemplate = `<html><head><title>Relatório de RTs</title><script src="https://cdn.tailwindcss.com"><\/script><style>body{font-family:'Inter'}@media print{.no-print{display:none}}</style></head><body class="p-8 bg-gray-100"><div class="no-print text-center mb-8"><button onclick="window.print()" class="bg-blue-600 text-white py-2 px-6 rounded">Imprimir</button></div><div class="max-w-5xl mx-auto bg-white p-8 rounded shadow">${reportTableHtml}<div class="mt-8 text-right"><h2 class="text-xl font-bold">Soma Total (RT) a Pagar</h2><p class="text-3xl font-bold mt-1 text-emerald-600">${this.formatCurrency(grandTotalRt)}</p></div></div></body></html>`;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printTemplate);
            printWindow.document.close();
        }

        exportPagamentosXLSX(date) {
            const data = this.pagamentos[date];
            if (!data || data.length === 0) { console.error("Não há dados de pagamento para exportar para esta data."); return; }
            const groupedById = {};
            data.forEach(record => {
                const partnerId = record.id_parceiro || 'N/A';
                if (!groupedById[partnerId]) {
                    groupedById[partnerId] = { 'ID Parceiro': partnerId, 'Parceiro': record.parceiro || 'N/A', 'Venda': 0, 'RT': 0, 'Qtd. Vendas': 0 };
                }
                
                const valorVenda = this.parseCurrency(record.valor_venda || 0);
                const rtSalva = this.parseCurrency(record.rt_valor || 0);

                groupedById[partnerId]['Venda'] += valorVenda;
                groupedById[partnerId]['RT'] += rtSalva;
                groupedById[partnerId]['Qtd. Vendas']++;
            });
            const reportData = Object.values(groupedById);
            const worksheet = XLSX.utils.json_to_sheet(reportData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Relatório de Pagamentos");
            XLSX.writeFile(workbook, `Relatorio_Pagamentos_${date.replace(/\//g, '-')}.xlsx`);
        }
    }
</script>
</body>
</html>
